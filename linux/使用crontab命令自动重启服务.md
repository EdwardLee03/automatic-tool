

使用crontab命令自动重启服务
=================
循环运行的**计划任务**，Linux系统则是由`cron/crond`这个系统服务来控制的。Linux系统上面原本就有非常多的计划性工作，因此这个系统服务是默认启动的。另外，由于使用者自己也可以设置计划任务，所以Linux系统也提供了使用者控制计划任务的命令`crontab`。


### 一、crond简介
`crond`是Linux下**用来周期性地执行某种任务或等待处理某些事件的一个守护进程**。与Windows下的计划任务类似，当安装完成操作系统后，默认会安装此服务工具，并且会自动启动crond进程。**crond进程每分钟会定期检查是否有要执行的任务**，如果有要执行的任务，则自动执行该任务。

Linux下的**任务调度**分为两类，**系统任务调度和用户任务调度**。

**系统任务调度是指系统周期性所要执行的工作**，比如写缓存数据到硬盘、日志清理等。在`/etc`目录下有一个`crontab`文件，这个就是`系统任务调度的配置文件`。

```shell
$ cat /etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
```
**前四行是用来配置`crond`任务运行的环境变量**。第一行`SHELL`变量指定系统要使用哪个`shell`，这里是`bash`；第二行`PATH`变量指定系统执行命令的路径；第三行`MAILTO`变量指定crond的任务执行信息将通过电子邮件发送给`root`用户，如果值为空，则表示不发送任务执行信息给用户；第四行`HOME`变量指定在执行命令或者脚本时使用的主目录。

**用户任务调度是指用户定期要执行的工作**，比如用户数据备份、定时邮件提醒等。**用户可以使用`crontab`工具来定制自己的计划任务。**所有用户定义的**crontab文件**都被保存在`/var/spool/cron`目录中。其文件名与用户名一致。

用户所建立的**crontab文件**中，**每一行都代表一项任务，每行的每个字段代表一项设置**。它的格式共分为六个字段，前五段是时间设定段，第六段是要执行的命令段，格式如下：
> minute   hour   day   month   week   command


### 二、crond服务


### 三、crontab命令详解
```shell
$ man crontab
```

#### 5. 使用示例
**示例1：每1分钟检测是否需要重启ZooKeeper服务器进程**

见 [zkServer-crontab.sh](../zookeeper/zkServer-crontab.sh)


### 四、使用注意事项
#### 1. 注意环境变量问题
有时我们创建了一个`crontab`，但是`这个任务却无法自动执行，而手动执行这个任务却没有问题`，这种情况一般是`由于在crontab文件中没有配置环境变量引起的`。

在crontab文件中定义多个调度任务时，需要特别注意的一个问题就是`环境变量的设置`。因为我们手动执行某个任务时，是在当前shell环境下进行的，程序当然能找到环境变量，而`系统自动执行任务调度时，是不会加载任何环境变量的`。因此，**需要在crontab文件中指定任务运行所需的所有环境变量**，这样系统执行任务调度时就没有问题。

不要假定cron知道所需要的特殊环境，它其实并不知道。所以你要**保证在shell脚本中提供所有必要的路径和环境变量**，除了一些自动设置的全局变量。所以注意如下3点：
1. 脚本中涉及文件路径时写全局路径(绝对路径)；
2. 脚本执行要用到`java`或其他环境变量时，通过`source`命令引入环境变量；
3. 当手动执行脚本OK，但是crontab死活不执行时。这时必须大胆怀疑是环境变量惹的祸，并可以尝试在crontab中直接引入环境变量解决问题。

#### 2. 注意清理系统用户的邮件日志
`每条任务调度执行完毕，系统都会将任务输出信息通过电子邮件的形式发送给当前系统用户`，这样日积月累，日志信息会非常大，可能会影响系统的正常运行。因此，将每条任务进行重定向处理非常重要。

例如，可以在crontab文件中设置如下形式，忽略日志输出：
> */1 * * * * /usr/local/apache2/apachectl restart >/dev/null 2>&1

`>/dev/null 2>&1`表示先将标准输出重定向到`/dev/null`，然后将标准错误重定向到标准输出。由于标准输出已经重定向到了`/dev/null`，因此标准错误也会重定向到`/dev/null`，这样日志输出问题就解决了。

#### 3. 其他注意事项
新创建的cron job，不会马上执行，至少要过2分钟才执行。如果重启`cron`，则马上执行。

当`crontab`突然失效时，可以尝试`/etc/init.d/crond restart`解决问题。或者查看日志看某个job有没有执行报错`tail -f /var/log/cron`。

千万别乱运行`crontab -r`。它从crontab目录(`/var/spool/cron`)中删除用户的crontab文件。删除了该用户的所有crontab，都没了。

在crontab中`%`是有特殊含义的，表示`换行`的意思。如果要用的话必须进行转义`\%`，如经常用的`date '+%Y%m%d'`在crontab里是不会执行的，应该换成`date '+\%Y\%m\%d'`。


### 参考
* [crontab命令 自动重启服务](https://blog.csdn.net/killmice/article/details/52852974)


------
祝玩得开心！ˇˍˇ
云舒，2019.2.28，杭州

